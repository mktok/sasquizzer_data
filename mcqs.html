<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAS Quizzer by MKT</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="h-full flex flex-col bg-gray-900 text-gray-100 transition-colors duration-500">

  <!-- Header with Back Button -->
  <header class="flex items-center justify-between px-4 py-3 bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
    <button id="backButton" class="text-sky-400 hover:text-sky-300 font-semibold text-lg transition">
      ← Back
    </button>

    <a class="text-2xl font-bold text-sky-400 text-center flex-grow" href="/">SAS Quizzer</a>

    <div class="w-16"></div> <!-- spacer -->
  </header>

  <div class="flex justify-center items-start mt-4 pb-24 px-2">
    <div class="h-full w-full max-w-3xl">

      <!-- Quiz Title -->
      <div id="title" class="text-xl font-bold text-sky-400 text-center pb-3"></div>

      <!-- Status Message (only shown on error) -->
      <div id="status" class="hidden bg-red-700 text-white text-center py-2 text-sm rounded-lg"></div>

      <!-- Question Section -->
      <section class="bg-gray-700 shadow-md px-4 py-4 rounded-lg border-b border-gray-700">
        <div id="qnum" class="text-sky-400 font-bold mb-2">Question —</div>
        <div id="question" class="text-lg font-medium leading-snug">—</div>
      </section>

      <!-- Scrollable Options -->
      <main id="optsContainer" class="flex-grow overflow-y-auto px-4 py-3 mb-24">
        <div id="opts" class="grid gap-3"></div>
      </main>

      <!-- Meta Info -->
      <div id="meta" class="hidden bg-sky-400 text-black px-3 py-2 rounded-lg font-small inline-block mb-2"></div>

      <!-- Navigation Buttons -->
      <div
        class="fixed bottom-10 left-1/2 transform -translate-x-1/2 w-full max-w-3xl bg-gray-700 rounded-lg border-t border-gray-700 px-4 py-3 flex flex-col sm:flex-row items-center justify-between gap-2">

        <button id="prev" class=" text-xl px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-600 w-full sm:w-auto">
          ◀ 
        </button>

        <!-- Numbered Question Buttons -->
        <div id="qButtonsContainer"
             class="flex gap-2 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800 px-2 py-1 w-full sm:w-auto justify-center">
          <!-- Question buttons will be generated dynamically -->
        </div>

        <button id="next" class=" text-xl px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-600 w-full sm:w-auto">
           ▶
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer
    class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 text-gray-400 text-xs text-center py-2 flex items-center justify-between">
    <div>Use ← → keys and 1–4 to choose</div>
    <div>© 2025 SAS Quizzer by MKT</div>
  </footer>

  <script>
    // Back Button
    document.getElementById('backButton').addEventListener('click', () => window.history.go(-1));

    // URL Params
    const params = new URLSearchParams(window.location.search);
    const file = params.get('file');
    const type = params.get('type');
    const displayfield = params.get('displayfield');
    const CSV_PATH = `https://raw.githubusercontent.com/mktok/sasquizzer_v1/refs/heads/main/data/${type}/${file}`;

    // Elements
    const status = document.getElementById('status');
    const qnumEl = document.getElementById('qnum');
    const questionEl = document.getElementById('question');
    const optsEl = document.getElementById('opts');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const progressEl = document.getElementById('progress');
    const metaEl = document.getElementById('meta');
    const title = document.getElementById('title');
    const qButtonsContainer = document.getElementById('qButtonsContainer');

    title.textContent = displayfield || "MCQ Viewer";

    let questions = [];
    let idx = 0;

    function normalizeFields(fields) {
      fields = fields.map(f => typeof f === 'string' ? f.trim() : f);
      if (fields.length >= 6) {
        const answer = fields[fields.length - 2];
        const options = fields.slice(1, 5);
        return {
          question: fields[0],
          options,
          answer: (answer || '').trim().charAt(0).toUpperCase(),
          meta: fields[fields.length - 1] || ''
        };
      }
      return null;
    }

    function renderQuestionButtons() {
      qButtonsContainer.innerHTML = "";
      questions.forEach((_, i) => {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        btn.className = `px-3 py-1 mb-4 rounded-md text-sm font-semibold transition ${
          i === idx
            ? "bg-sky-500 text-black"
            : "bg-gray-800 text-gray-300 hover:bg-gray-600"
        }`;
        btn.onclick = () => {
          idx = i;
          render();
        };
        qButtonsContainer.appendChild(btn);
      });
    }

    function render() {
      if (!questions.length) {
        qnumEl.textContent = "No questions found";
        questionEl.textContent = "";
        optsEl.innerHTML = "";
        return;
      }

      const q = questions[idx];
      qnumEl.textContent = `Question ${idx + 1}`;
      questionEl.textContent = q.question;
      optsEl.innerHTML = "";

      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className =
          "opt block w-full text-left px-4 py-3 rounded-lg border border-gray-700 bg-gray-700 hover:bg-gray-600 transition";
        btn.innerHTML = `<b>${String.fromCharCode(65 + i)}.</b> ${opt}`;
        btn.onclick = () => handleSelection(i);
        optsEl.appendChild(btn);
      });

      metaEl.classList.add("hidden");
      renderQuestionButtons();
    }

    function handleSelection(i) {
      const q = questions[idx];
      const correctIdx = q.answer.charCodeAt(0) - 65;
      const buttons = optsEl.children;

      for (let b = 0; b < buttons.length; b++) {
        buttons[b].disabled = true;
        buttons[b].classList.remove("bg-green-800", "bg-red-800", "text-white");
      }

      if (i === correctIdx) {
        buttons[i].classList.add("bg-green-800", "text-white");
      } else {
        buttons[i].classList.add("bg-red-800", "text-white");
        if (buttons[correctIdx])
          buttons[correctIdx].classList.add("bg-green-800", "text-white");
      }

      metaEl.classList.remove("hidden");
      metaEl.textContent = "Refer: " + (q.meta || "");
      renderQuestionButtons();
    }

    // Navigation
    prevBtn.onclick = () => {
      if (idx > 0) {
        idx--;
        render();
      }
    };
    nextBtn.onclick = () => {
      if (idx < questions.length - 1) {
        idx++;
        render();
      }
    };

    // Keyboard Shortcuts
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") nextBtn.click();
      if (e.key === "ArrowLeft") prevBtn.click();
      if (["1", "2", "3", "4"].includes(e.key)) {
        const n = parseInt(e.key) - 1;
        if (optsEl.children[n]) optsEl.children[n].click();
      }
    });

    // Load CSV
    Papa.parse(CSV_PATH, {
      download: true,
      skipEmptyLines: true,
      complete: function (res) {
        try {
          questions = res.data.map(normalizeFields).filter(Boolean);
          if (!questions.length) {
            status.textContent = "No valid questions found.";
            status.classList.remove("hidden");
            return;
          }
          render();
        } catch (err) {
          status.textContent = "Error parsing questions.";
          status.classList.remove("hidden");
        }
      },
      error: function (err) {
        status.textContent = "Error loading CSV file.";
        status.classList.remove("hidden");
        console.error(err);
      },
    });
  </script>
</body>
</html>
