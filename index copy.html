<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MCQ Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--ok:#16a34a;--err:#ef4444}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#071029, #071a2b);color:#e6eef8}
    .wrap{width:min(920px,96vw);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.05));border-radius:12px;padding:24px;box-shadow:0 8px 30px rgba(2,6,23,.6);}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:18px;margin:0}
    .meta{color:var(--muted);font-size:13px}
    .card{background:var(--card);padding:20px;border-radius:10px}
    .qnum{font-weight:600;color:var(--accent);margin-bottom:8px}
    .question{font-size:18px;line-height:1.4;margin-bottom:14px}
    .opts{display:grid;gap:10px}
    .opt{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:12px;cursor:pointer}
    .opt input{transform:scale(1.1)}
    .opt.selected{outline:2px solid rgba(96,165,250,0.12);background:linear-gradient(90deg,rgba(96,165,250,0.03),transparent)}
    .controls{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:14px}
    .left{display:flex;gap:8px;align-items:center}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#3b82f6);border:none;color:#021129}
    button:disabled{opacity:0.45;cursor:not-allowed}
    .small{font-size:13px;color:var(--muted)}
    .reveal{margin-left:8px;padding:6px 10px;border-radius:6px}
    .correct{border-color:rgba(4, 142, 54, 0.856);background:rgba(22, 163, 74, 0.768)}
    .wrong{border-color:rgba(239,68,68,0.15);background:rgba(239,68,68,0.04)}
    footer{margin-top:12px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between}
    .loader{display:inline-block;width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:560px){.question{font-size:16px}}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="MCQ viewer">
    <header>
      <div>
        <h1>MCQ Viewer</h1>
        <div class="meta">Loads questions from <code>/data/pc08_gar1990_ch01.csv</code></div>
      </div>
      <div class="meta" id="status">Loading <span class="loader"></span></div>
    </header>

    <div class="card">
      <div class="qnum" id="qnum">Question —</div>
      <div class="question" id="question"> — </div>
      <div class="opts" id="opts"></div>

      <div class="controls">
        <div class="left">
          <button id="prev">◀ Prev</button>
          <button id="next">Next ▶</button>
          <button id="showAnswer" class="reveal">Show Answer</button>
        </div>
        <div class="small" id="progress">0 / 0</div>
      </div>

      <footer>
        <div id="meta">&nbsp;</div>
        <div class="small">Use arrow keys ← → and numbers 1–4 to choose</div>
      </footer>
    </div>
  </div>

  <script>
    // const CSV_PATH = 'https://raw.githubusercontent.com/mktok/sasquizzer_data/refs/heads/main/pc08_gar1990_ch01.csv';
    const CSV_PATH = '/data/pc08_gar1990_ch01.csv';
    const status = document.getElementById('status');
    const qnumEl = document.getElementById('qnum');
    const questionEl = document.getElementById('question');
    const optsEl = document.getElementById('opts');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const progressEl = document.getElementById('progress');
    const showBtn = document.getElementById('showAnswer');
    const metaEl = document.getElementById('meta');

    let questions = [];
    let idx = 0;

    function normalizeFields(fields){
      // Trim all
      fields = fields.map(f => typeof f === 'string' ? f.trim() : f);
      // heuristics: last field might be meta like [Rule: ...]
      // last-but-one likely single letter answer like A/B/C/D
      if(fields.length >= 6){
        const answer = fields[fields.length-2];
        // options assumed to be 4 fields after question
        const possibleOptions = fields.slice(1, 5);
        if(possibleOptions.length === 4){
          return {
            question: fields[0].replace(/^"|"$/g,'').trim(),
            options: possibleOptions.map(s => s.replace(/^"|"$/g,'').trim()),
            answer: (typeof answer === 'string') ? answer.replace(/^\s+|\s+$/g,'').charAt(0).toUpperCase() : '' ,
            meta: fields[fields.length-1] || ''
          }
        }
      }
      // fallback: try last two as answer/meta and everything before first comma as question
      if(fields.length >= 3){
        const answer = fields[fields.length-2] || '';
        const opts = fields.slice(1, fields.length-2);
        return {
          question: fields[0],
          options: opts,
          answer: (answer||'').trim().charAt(0).toUpperCase(),
          meta: fields[fields.length-1] || ''
        }
      }
      return null;
    }

    function render(){
      if(questions.length === 0){
        qnumEl.textContent = 'No questions found';
        questionEl.textContent = '';
        optsEl.innerHTML = '';
        status.textContent = 'Ready';
        return;
      }
      const q = questions[idx];
      qnumEl.textContent = `Question ${String(idx+1).padStart(2,'0')}`;
      questionEl.textContent = q.question || '—';
      optsEl.innerHTML = '';
      q.options.forEach((opt, i) => {
        const label = document.createElement('label');
        label.className = 'opt';
        label.tabIndex = 0;
        label.dataset.index = i;
        label.innerHTML = `
          <input type="radio" name="choice" value="${String.fromCharCode(65+i)}" aria-label="Option ${i+1}">
          <div>${opt}</div>
        `;
        label.addEventListener('click', () => selectOption(i));
        label.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectOption(i); } });
        optsEl.appendChild(label);
      });
      progressEl.textContent = `${idx+1} / ${questions.length}`;
      metaEl.textContent = q.meta || '';
      // reset reveal
      Array.from(optsEl.children).forEach(c => c.classList.remove('correct','wrong','selected'));
      const checked = optsEl.querySelector('input:checked'); if(checked) checked.checked = false;
    }

    function selectOption(i){
      const labels = Array.from(optsEl.children);
      labels.forEach((l,ix)=>{
        l.classList.toggle('selected', ix===i);
        const inp = l.querySelector('input'); inp.checked = ix===i;
      });
    }

    function showAnswer(){
      const q = questions[idx];
      if(!q) return;
      const correctLetter = (q.answer||'').toUpperCase();
      const correctIndex = correctLetter ? correctLetter.charCodeAt(0) - 65 : -1;
      const labels = Array.from(optsEl.children);
      labels.forEach((l, i)=>{
        l.classList.remove('correct','wrong');
        if(i === correctIndex) l.classList.add('correct');
        else {
          const inp = l.querySelector('input');
          if(inp.checked) l.classList.add('wrong');
        }
      });
    }

    prevBtn.addEventListener('click', ()=>{ if(idx>0) { idx--; render(); } });
    nextBtn.addEventListener('click', ()=>{ if(idx < questions.length-1){ idx++; render(); } });
    showBtn.addEventListener('click', showAnswer);

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight') nextBtn.click();
      if(e.key === 'ArrowLeft') prevBtn.click();
      if(['1','2','3','4'].includes(e.key)){
        const n = parseInt(e.key,10)-1;
        const labels = Array.from(optsEl.children); if(labels[n]) selectOption(n);
      }
      if(e.key === 'r' || e.key === 'R') showBtn.click();
    });

    // load CSV using PapaParse
    Papa.parse(CSV_PATH, {
      download: true,
      skipEmptyLines: true,
      complete: function(res){
		 console.log(res.data) ;
	  
        status.textContent = 'Parsing CSV';
        const parsed = res.data;
        const out = [];
        parsed.forEach((row)=>{
          // row can be array of single string if not split - ensure array
          const fields = Array.isArray(row) ? row : [row];
          const nf = normalizeFields(fields);
          if(nf) out.push(nf);
        });
        questions = out;
        status.textContent = `Loaded ${questions.length} questions`;
        render();
      },
      error: function(err){
        status.textContent = 'Failed to load CSV';
        console.error(err);
      }
    });
  </script>
</body>
</html>